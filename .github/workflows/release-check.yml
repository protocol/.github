# This workflow cannot post sticky comments on PRs from forked repositories.
# Instead, it outputs the message it would have posted as a workflow notice.
# See https://github.com/protocol/.github/issues/254 for details.

name: Release Checker
on: [ workflow_call ]

jobs:
  releaser:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v3
        with:
          go-version: "1.19.x"
      - id: version
        name: Determine version
        if: hashFiles('version.json')
        run: echo "version=$(jq -r .version version.json)" >> $GITHUB_OUTPUT
      - id: tag
        name: Check if the tag already exists
        # Check if a git tag for the version (as read from version.json) exists
        # If that is the case, we don't need to run the rest of the workflow.
        if: steps.version.outputs.version != ''
        run: |
          git fetch origin --tags
          status=0
          git rev-list "$VERSION" &> /dev/null || status=$?
          if [[ $status == 0 ]]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      - name: Install semver (node command line tool)
        if: steps.tag.outputs.exists == 'false'
        run: npm install -g "https://github.com/npm/node-semver#e79ac3a450e8bb504e78b8159e3efc7089569" # v7.3.5
      - name: Check version
        if: steps.tag.outputs.exists == 'false'
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: semver "$VERSION" # fails if the version is not a valid semver version (e.g. v0.1 would fail)
      - id: prev
        name: Determine version number to compare to
        if: steps.tag.outputs.exists == 'false'
        env:
          VERSION: ${{ steps.version.outputs.version }}
        # We need to determine the version number we want to compare to,
        # taking into account that this might be a (patch) release on a release branch.
        # Example:
        # Imagine a module that has releases for v0.1.0, v0.2.0 and v0.3.0.
        # When trying to cut a release v0.2.1, we need to base our comparisons on v0.2.0.
        # When trying to cut a release v0.3.1 or v0.4.0, we need to base our comparisons on v0.3.0.
        run: |
          git fetch origin --tags
          go install github.com/marten-seemann/semver-highest@fcdc98f8820ff0e6613c1bee071c096febd98dbf
          v=$(semver-highest -target "$VERSION" -versions $(git tag | paste -sd , -))
          status=$?
          if [[ $status != 0 ]]; then
            echo $v
            exit $status
          fi
          echo "version=$v" >> $GITHUB_OUTPUT
      - name: Post output
        if: steps.tag.outputs.exists == 'false' && steps.prev.outputs.version == ''
        uses: marocchino/sticky-pull-request-comment@82e7a0d3c51217201b3fedc4ddde6632e969a477 # v2.1.1
        with:
          header: release-check
          recreate: true
          message: |
            Suggested version: `${{ steps.version.outputs.version }}`

            This is the first release of this module.
      - id: git-diff
        name: run git diff on go.mod file(s)
        if: steps.tag.outputs.exists == 'false' && steps.prev.outputs.version != ''
        env:
          PREV_VERSION: ${{ steps.prev.outputs.version }}
        run: |
          # First get the diff for the go.mod file in the root directory...
          output=$(git diff "$PREV_VERSION..HEAD" -- './go.mod')
          # ... then get the diff for all go.mod files in subdirectories.
          # Note that this command also finds go.mod files more than one level deep in the directory structure.
          output+=$(git diff "$PREV_VERSION..HEAD" -- '*/go.mod')
          if [[ -z "$output" ]]; then
            output="(empty)"
          fi
          printf "output<<EOF\n%s\nEOF" "$output" >> $GITHUB_OUTPUT
      - id: gorelease
        name: Run gorelease
        if: steps.tag.outputs.exists == 'false' && steps.prev.outputs.version != ''
        env:
          PREV_VERSION: ${{ steps.prev.outputs.version }}
        # see https://github.com/golang/exp/commits/master/cmd/gorelease
        run: |
          go mod download
          go install golang.org/x/exp/cmd/gorelease@b4e88ed8e8aab63a9aa9a52276782ebbc547adef
          output=$((gorelease -base "$PREV_VERSION") 2>&1 || true)
          printf "output<<EOF\n%s\nEOF" "$output" >> $GITHUB_OUTPUT
      - id: gocompat
        name: Check Compatibility
        if: steps.tag.outputs.exists == 'false' && steps.prev.outputs.version != ''
        env:
          PREV_VERSION: ${{ steps.prev.outputs.version }}
        run: |
          go install github.com/smola/gocompat/cmd/gocompat@8498b97a44792a3a6063c47014726baa63e2e669 # v0.3.0
          output=$(gocompat compare --go1compat --git-refs="$PREV_VERSION..HEAD" ./... || true)
          if [[ -z "$output" ]]; then
            output="(empty)"
          fi
          printf "output<<EOF\n%s\nEOF" "$output" >> $GITHUB_OUTPUT
      - id: footnote
        if: github.base_ref != github.event.repository.default_branch
        env:
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          BASE_REF: ${{ github.base_ref }}
        run: |
          echo "output<<EOF
          ---
          ## Cutting a Release (when not on \`$DEFAULT_BRANCH\`)

          This PR is targeting \`$BASE_REF\`, which is not the default branch.
          If you wish to cut a release once this PR is merged, please add the \`release\` label to this PR.
          EOF" >> $GITHUB_ENV
      - id: message
        if: steps.tag.outputs.exists == 'false' && steps.prev.outputs.version != ''
        env:
          VERSION: ${{ steps.version.outputs.version }}
          PREV_VERSION: ${{ steps.prev.outputs.version }}
          BASE_HTML_URL: ${{ github.event.pull_request.base.repo.html_url }}
          HEAD_LABEL: ${{ github.event.pull_request.head.label }}
          GIT_DIFF: ${{ steps.git-diff.outputs.output }}
          GORELEASE: ${{ steps.gorelease.outputs.output }}
          GOCOMPAT: ${{ steps.gocompat.outputs.output }}
          FOOTNOTE: ${{ steps.footnote.outputs.output }}
        run: |
          echo 'output<<EOF
          Suggested version: `$VERSION`
          Comparing to: [`$PREV_VERSION`]($BASE_HTML_URL/releases/tag/$PREV_VERSION) ([diff]($HTML_URL/compare/$PREV_VERSION..$HEAD_LABEL))

          Changes in `go.mod` file(s):
          ```diff
          $GIT_DIFF
          ```

          `gorelease` says:
          ```
          $GORELEASE
          ```

          `gocompat` says:
          ```
          $GOCOMPAT
          ```
          $FOOTNOTE
          EOF' >> $GITHUB_OUTPUT
      - name: Post message on PR
        uses: marocchino/sticky-pull-request-comment@82e7a0d3c51217201b3fedc4ddde6632e969a477 # v2.1.1
        if: steps.tag.outputs.exists == 'false' && steps.prev.outputs.version != '' && github.event.pull_request.head.repo.full_name == github.repository
        with:
          header: release-check
          recreate: true
          message: ${{ steps.message.outputs.output }}
      - name: Set a notice message on run
        if: steps.tag.outputs.exists == 'false' && steps.prev.outputs.version != '' && github.event.pull_request.head.repo.full_name != github.repository
        env:
          MESSAGE: ${{ steps.message.outputs.output }}
        run: |
          message="${MESSAGE//'%'/'%25'}"
          message="${message//$'\n'/'%0A'}"
          message="${message//$'\r'/'%0D'}"
          echo "::notice ::$message"
