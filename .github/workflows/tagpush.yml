name: Manual Release Nag
on: [ workflow_call ]

jobs:
  unit:
    runs-on: ubuntu-latest
    name: All
    steps:
      - uses: actions/checkout@v3
      - run: cat "$GITHUB_EVENT_PATH" | jq -M .
      - id: tag
        name: extract tag name
        run: |
          name=$(echo "$GITHUB_REF" | sed "s/refs\/tags\///")
          echo "name=$name" >> $GITHUB_OUTPUT
          echo "name=$name"
      - name: create issue template file
        if: github.event.pusher.name != 'web3-bot'
        env:
          PUSHER: ${{ github.event.pusher.name }}
          TAGNAME: ${{ steps.tag.outputs.name }}
          ISSUE_TEMPLATE: |
            ---
            title: manual release created (${{ steps.tag.outputs.name }})
            assignees: ${{ github.event.pusher.name }}
            ---
            @${{ github.event.pusher.name }} just pushed a release tag: ${{ steps.tag.outputs.name }}.
            Please manually verify validity (using [`gorelease`](https://pkg.go.dev/golang.org/x/exp/cmd/gorelease)), and update `version.json` to reflect the manually released version, if necessary.
            In the future, please use the [automated process](https://github.com/protocol/.github/blob/master/VERSIONING.md).
        run: |
          echo "$ISSUE_TEMPLATE" > .github/workflows/tagpush.md
          echo "$ISSUE_TEMPLATE"
      - name: create an issue
        if: github.event.pusher.name != 'web3-bot'
        uses: JasonEtco/create-an-issue@9e6213aec58987fa7d2f4deb8b256b99e63107a2 # v2.6.0
        env:
          GITHUB_TOKEN: ${{ github.token }}
          PUSHER: ${{ github.event.pusher.name }}
        with:
          filename: .github/workflows/tagpush.md
      - name: fail build if push wasn't done by web3-bot
        if: github.event.pusher.name != 'web3-bot'
        run: exit 1
